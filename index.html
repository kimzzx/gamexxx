<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Survivors of the Absurd</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      user-select: none;
    }
    .xp-pulse {
      box-shadow: 0 0 14px rgba(129,140,248,0.9);
    }

    canvas {
      display: block;
      touch-action: none;
    }
  </style>
</head>
<body class="bg-slate-950 text-white">
  <div id="game-root" class="relative w-screen h-screen overflow-hidden">
    <!-- GAME CANVAS -->
    <canvas id="game" class="w-full h-full"></canvas>

    <!-- HUD TOP -->
    <div class="absolute top-0 inset-x-0 p-3 flex items-start justify-between pointer-events-none text-xs">
      <!-- HP / EXP / TIME / GOLD -->
      <div class="flex flex-col gap-2 pointer-events-auto">
      </div>  
        <!-- HP -->
        <div class="flex items-center gap-2">
          <span class="text-slate-200 text-[11px]">HP</span>
          <div class="w-32 h-3 bg-slate-900/80 rounded-full overflow-hidden border border-slate-700/80">
            <div id="hp-bar"
                 class="h-full bg-gradient-to-r from-emerald-400 via-yellow-400 to-red-500"
                 style="width:100%;"></div>
          </div>
        </div>
        <!-- EXP -->
        <div class="flex items-center gap-2">
          <span class="text-slate-200 text-[11px]">
            LV <span id="level-label" class="text-cyan-300 font-semibold">1</span>
          </span>
          <div class="w-40 h-2.5 bg-slate-900/80 rounded-full overflow-hidden border border-indigo-600/80">
            <div id="xp-bar"
                 class="h-full bg-gradient-to-r from-indigo-400 via-fuchsia-400 to-cyan-300"
                 style="width:0%;"></div>
          </div>
        </div>
        <!-- Stats -->
        <div class="flex flex-wrap gap-2 text-[11px] text-slate-300">
          <span>‚è± <span id="time-label" class="text-cyan-300 font-semibold">0.0</span>s</span>
          <span>‚ò† ‡∏Ü‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß <span id="kills-label" class="text-emerald-300 font-semibold">0</span></span>
          <span>üí∞ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ <span id="gold-run-label" class="text-yellow-300 font-semibold">0</span></span>
        </div>
      </div>

      <!-- MINI MAP + DESTINY EVENT BANNER -->
      <div class="pointer-events-auto flex flex-col items-end gap-2">
        <div class="bg-slate-900/80 border border-slate-700 rounded-xl p-2 w-28">
          <div class="flex items-center justify-between mb-1">
            <span class="text-[11px] text-slate-300">Mini-map</span>
            <span class="text-[9px] text-slate-500">Proto</span>
          </div>
          <div class="relative w-full aspect-square bg-slate-800/80 rounded-md overflow-hidden" id="minimap">
          </div>
        </div>

        <div id="destiny-banner"
             class="px-3 py-1 rounded-full bg-sky-500/10 border border-sky-400/40 text-[10px] text-sky-100 hidden">
          ‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ü‡πâ‡∏≤‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï: -
        </div>

        <!-- üéß Volume Control -->
        <div class="mt-1 flex items-center gap-2 bg-slate-900/80 border border-slate-700 rounded-full px-2 py-1 text-[10px]">
          <span class="text-slate-300">üîä</span>
          <input id="volume-slider" type="range"
                 min="0" max="100" value="60"
                 class="w-24 h-1 bg-slate-700 rounded-lg accent-cyan-400">
        </div>
      </div>
      </div>

    <!-- HUD BOTTOM: WEAPON / PASSIVE BAR -->
    <div class="absolute bottom-0 inset-x-0 pb-2 px-3 pointer-events-none text-[10px]">
      <div class="max-w-3xl mx-auto bg-slate-900/90 border border-slate-700/60 rounded-2xl px-3 py-2 flex flex-col gap-1">
        <div class="flex items-center justify-between text-slate-300">
          <span>‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò & ‡∏™‡∏Å‡∏¥‡∏•</span>
          <span class="text-[9px] text-slate-500">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏ä‡πà‡∏≠‡∏á</span>
        </div>
        <div id="skill-bar" class="grid grid-cols-3 sm:grid-cols-6 gap-1">
          <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
    </div>

    <!-- BOSS HP -->
    <div id="boss-hp-container"
         class="absolute top-12 inset-x-0 flex justify-center pointer-events-none hidden">
      <div class="bg-slate-900/90 border border-fuchsia-500/70 rounded-full px-3 py-1 shadow-lg backdrop-blur">
        <div id="boss-name" class="text-[11px] text-fuchsia-200 text-center mb-1">Boss HP</div>
        <div class="w-60 h-2.5 bg-slate-800/80 rounded-full overflow-hidden border border-fuchsia-500/70">
          <div id="boss-hp-bar"
               class="h-full bg-gradient-to-r from-red-500 via-fuchsia-400 to-purple-500"
               style="width:100%;"></div>
        </div>
      </div>
    </div>

    <!-- MOBILE JOYSTICK -->
    <div id="joystick"
        class="absolute bottom-20 left-4 sm:bottom-6 w-24 h-24 rounded-full bg-slate-900/40 border border-slate-600/80 flex items-center justify-center select-none sm:opacity-80">
      <div id="joystick-knob" class="w-10 h-10 rounded-full bg-slate-100/80 shadow-md"></div>
    </div>


    <!-- MAIN MENU -->
    <div id="screen-main-menu"
         class="absolute inset-0 bg-slate-950/90 backdrop-blur flex items-center justify-center z-40">
      <div class="bg-slate-900/90 border border-slate-700/80 rounded-3xl p-6 max-w-xl w-[92%] shadow-2xl">
        <h1 class="text-2xl font-semibold text-center mb-2">Survivors of the Absurd</h1>
        <p class="text-xs text-slate-300 text-center mb-4 leading-relaxed">
          ‡πÄ‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏ù‡∏π‡∏á‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô ‡πÄ‡∏Å‡πá‡∏ö EXP & ‡∏ó‡∏≠‡∏á<br>
          ‡∏ã‡∏∑‡πâ‡∏≠ Power-ups ‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ
        </p>

        <div class="flex items-center justify-center mb-3 text-[11px] text-yellow-300 gap-1">
          üí∞ ‡∏ó‡∏≠‡∏á‡∏ñ‡∏≤‡∏ß‡∏£: <span id="meta-gold" class="font-semibold">0</span>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
          <button id="btn-main-start"
                  class="col-span-2 py-2 rounded-2xl bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold transition">
            ‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
          </button>
          <button
            class="py-2 rounded-2xl bg-slate-800/90 border border-slate-600 text-slate-100 hover:border-cyan-400 transition cursor-default">
            ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
          </button>
          <button id="btn-main-powerups"
            class="py-2 rounded-2xl bg-slate-800/90 border border-slate-600 text-slate-100 hover:border-emerald-400 transition">
            Power-ups
          </button>
          <button
            class="py-2 rounded-2xl bg-slate-800/90 border border-slate-600 text-slate-100 hover:border-slate-500 transition cursor-default">
            Collection
          </button>
          <button
            class="py-2 rounded-2xl bg-slate-800/90 border border-slate-600 text-slate-100 hover:border-slate-500 transition cursor-default">
            Secrets
          </button>
        </div>
        <p class="text-[11px] text-slate-400 text-center">
          ‡∏Ñ‡∏≠‡∏°: W A S D / ‡∏•‡∏π‡∏Å‡∏®‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏ô ‚Ä¢ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏ä‡πâ‡∏à‡∏≠‡∏¢‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
        </p>
      </div>
    </div>

    <!-- POWER-UPS MENU -->
    <div id="screen-powerups"
         class="absolute inset-0 bg-slate-950/80 backdrop-blur flex items-center justify-center z-50 hidden">
      <div class="bg-slate-900/95 border border-emerald-500/60 rounded-3xl p-5 max-w-xl w-[96%] shadow-2xl text-xs">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ñ‡∏≤‡∏ß‡∏£ (Power-ups)</h2>
          <button id="btn-close-powerups"
                  class="text-[11px] px-2 py-1 rounded-full bg-slate-800 hover:bg-slate-700">
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
        <div class="mb-3 text-[11px] text-slate-300 flex items-center gap-2">
          üí∞ ‡∏ó‡∏≠‡∏á‡∏ñ‡∏≤‡∏ß‡∏£: <span id="meta-gold-2" class="font-semibold text-yellow-300">0</span>
          <span class="text-slate-500">* ‡∏ó‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≠‡∏ö</span>
        </div>
        <div id="powerup-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
    </div>

    <!-- CHARACTER & STAGE SELECT -->
    <div id="screen-char-stage"
         class="absolute inset-0 bg-slate-950/90 backdrop-blur flex items-center justify-center z-30 hidden">
      <div class="bg-slate-900/95 border border-slate-700 rounded-3xl p-5 max-w-4xl w-[96%] shadow-2xl text-xs">
        <h2 class="text-lg font-semibold text-center mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ & ‡∏î‡πà‡∏≤‡∏ô</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Characters -->
          <div>
            <h3 class="text-[11px] text-slate-300 mb-2">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Characters)</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2" id="character-list">
              <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
            </div>
          </div>

          <!-- Stages -->
          <div>
            <h3 class="text-[11px] text-slate-300 mb-2">‡∏î‡πà‡∏≤‡∏ô (Stages)</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2" id="stage-list">
              <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-col sm:flex-row gap-2 justify-between items-center">
          <div class="text-[11px] text-slate-400">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
          </div>
          <button id="btn-start-run"
                  class="px-4 py-2 rounded-2xl bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold text-xs disabled:opacity-40 disabled:cursor-not-allowed">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô!
          </button>
        </div>
      </div>
    </div>

    <!-- LEVEL UP -->
    <div id="screen-levelup"
         class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center z-30 hidden">
      <div class="bg-slate-900/95 border border-slate-700 rounded-3xl p-5 max-w-3xl w-[96%] shadow-2xl text-xs">
        <h2 class="text-lg font-semibold text-center mb-2">‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏Å‡∏¥‡∏• / ‡∏™‡πÄ‡∏ï‡∏ï‡∏±‡∏™</h2>
        <p class="text-[11px] text-slate-300 text-center mb-3">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        </p>
        <div id="levelup-options" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
      </div>
    </div>

    <!-- GAME OVER -->
    <div id="screen-gameover"
         class="absolute inset-0 bg-slate-950/85 backdrop-blur flex items-center justify-center z-40 hidden">
      <div class="bg-slate-900/95 border border-slate-700 rounded-3xl p-6 max-w-sm w-[92%] text-center shadow-2xl text-xs">
        <h2 class="text-xl font-semibold mb-2 text-white">Game Over</h2>
        <p class="text-slate-300 mb-2">
          ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏õ <span id="go-time" class="text-cyan-300 font-semibold">0.0</span> ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ<br>
          ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÑ‡∏î‡πâ <span id="go-kills" class="text-emerald-300 font-semibold">0</span> ‡∏ï‡∏±‡∏ß<br>
          ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á <span id="go-level" class="text-indigo-300 font-semibold">1</span><br>
          ‡πÑ‡∏î‡πâ‡∏ó‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ <span id="go-gold" class="text-yellow-300 font-semibold">0</span>
        </p>
        <button id="btn-restart"
                class="mt-3 w-full py-2.5 rounded-2xl bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold text-sm transition">
          ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
        </button>
      </div>
    </div>
  </div>

  <script>
    // === DOM =========================================================
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const hpBar = document.getElementById('hp-bar');
    const xpBar = document.getElementById('xp-bar');
    const levelLabel = document.getElementById('level-label');
    const timeLabel = document.getElementById('time-label');
    const killsLabel = document.getElementById('kills-label');
    const goldRunLabel = document.getElementById('gold-run-label');
    const volumeSlider = document.getElementById('volume-slider'); 
    const bossHpContainer = document.getElementById('boss-hp-container');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const bossNameLabel = document.getElementById('boss-name');

    const joystick = document.getElementById('joystick');
    const joystickKnob = document.getElementById('joystick-knob');

    const screenMainMenu = document.getElementById('screen-main-menu');
    const screenCharStage = document.getElementById('screen-char-stage');
    const screenLevelup = document.getElementById('screen-levelup');
    const screenGameover = document.getElementById('screen-gameover');
    const screenPowerups = document.getElementById('screen-powerups');

    const btnMainStart = document.getElementById('btn-main-start');
    const btnMainPowerups = document.getElementById('btn-main-powerups');
    const btnStartRun = document.getElementById('btn-start-run');
    const btnRestart = document.getElementById('btn-restart');
    const btnClosePowerups = document.getElementById('btn-close-powerups');

    const characterListEl = document.getElementById('character-list');
    const stageListEl = document.getElementById('stage-list');
    const levelupOptionsEl = document.getElementById('levelup-options');
    const skillBarEl = document.getElementById('skill-bar');
    const minimapEl = document.getElementById('minimap');
    const destinyBanner = document.getElementById('destiny-banner');

    const goTime = document.getElementById('go-time');
    const goKills = document.getElementById('go-kills');
    const goLevel = document.getElementById('go-level');
    const goGold = document.getElementById('go-gold');

    const metaGoldLabel = document.getElementById('meta-gold');
    const metaGoldLabel2 = document.getElementById('meta-gold-2');
    const powerupListEl = document.getElementById('powerup-list');


    // === VOLUME SLIDER ==========================================
    if (volumeSlider) {
      volumeSlider.addEventListener('input', () => {
        const v = volumeSlider.value / 100;
        if (!bgm) {
          initBgm();
        }
        bgm.volume = v;
      });
    }


    function xpPulse() {
      xpBar.classList.add('xp-pulse');
      setTimeout(() => {
        xpBar.classList.remove('xp-pulse');
      }, 180);
    }


    // === META (LOCALSTORAGE) =========================================
    const META_KEY = 'soa_meta_v1';
    function loadMeta() {
      try {
        const raw = localStorage.getItem(META_KEY);
        if (!raw) return { gold: 0, powerups: {} };
        const obj = JSON.parse(raw);
        if (!obj.powerups) obj.powerups = {};
        if (typeof obj.gold !== 'number') obj.gold = 0;
        return obj;
      } catch (e) {
        return { gold: 0, powerups: {} };
      }
    }
    function saveMeta() {
      localStorage.setItem(META_KEY, JSON.stringify(meta));
      metaGoldLabel.textContent = meta.gold.toString();
      metaGoldLabel2.textContent = meta.gold.toString();
    }
    const meta = loadMeta();

    // === GAME DEFINITIONS ============================================
    const CHARACTERS = {
      pong: {
        id: 'pong',
        name: '‡∏•‡∏∏‡∏á‡∏õ‡πã‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞‡∏û‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏®‡∏©',
        desc: '‡πÑ‡∏°‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì | Passive: ‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞',
        color: 'border-emerald-400/60 hover:border-emerald-300',
        hp: 130,
        speed: 210,
        baseDamage: 1.4,
        weaponType: 'stick',
        passive: 'trashTreasure'
      },
      ning: {
        id: 'ning',
        name: '‡πÄ‡∏à‡πä‡∏´‡∏ô‡∏¥‡∏á‡∏Ç‡∏≤‡∏¢‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î‡∏•‡∏≠‡∏¢‡∏ü‡πâ‡∏≤',
        desc: '‡∏ô‡πà‡∏≠‡∏á‡πÑ‡∏Å‡πà‡∏¢‡∏±‡∏Å‡∏©‡πå‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î | Passive: ‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏ö',
        color: 'border-amber-400/60 hover:border-amber-300',
        hp: 110,
        speed: 225,
        baseDamage: 1.5,
        weaponType: 'chicken',
        passive: 'crispyBuff'
      },
      cat: {
        id: 'cat',
        name: '‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß‡∏™‡πâ‡∏°‡πÄ‡∏°‡∏µ‡πâ‡∏¢‡∏ß‡∏ö‡πâ‡∏≤‡∏û‡∏•‡∏±‡∏á',
        desc: '‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡∏ô‡∏ü‡∏π‡∏ü‡πà‡∏≠‡∏á | Passive: ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏ß‡∏á',
        color: 'border-fuchsia-400/60 hover:border-fuchsia-300',
        hp: 120,
        speed: 230,
        baseDamage: 1.3,
        weaponType: 'fluff',
        passive: 'sleepBuff'
      }
    };

    const STAGES = {
      garbage: {
        id: 'garbage',
        name: '‡∏ó‡∏∏‡πà‡∏á‡∏Ç‡∏¢‡∏∞‡∏™‡∏∏‡∏î‡∏™‡∏¢‡∏≠‡∏á',
        desc: '‡∏î‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏°‡∏µ‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô',
        theme: 'garbage'
      },
      market: {
        id: 'market',
        name: '‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏î‡∏û‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô',
        desc: '‡∏°‡∏µ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏á‡∏´‡∏°‡∏π ‡∏ú‡∏±‡∏Å‡∏ú‡∏•‡πÑ‡∏°‡πâ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ',
        theme: 'market'
      },
      classroom: {
        id: 'classroom',
        name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏Å‡∏•‡∏≤‡∏´‡∏•',
        desc: '‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ‡∏Ç‡∏ß‡∏≤‡∏á‡∏ó‡∏≤‡∏á ‡∏ö‡∏≠‡∏™‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏ì‡∏¥‡∏ï',
        theme: 'classroom'
      }
    };

    const SKILLS = [
      {
        id: 'multi',
        type: 'weapon',
        name: '‡∏¢‡∏¥‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏¥‡∏®',
        maxLevel: 5,
        descLv: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô +1 ‡∏ó‡∏¥‡∏®',
          '‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° +2 ‡∏ó‡∏¥‡∏®',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
          '‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏°‡∏∏‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏¢‡∏¥‡∏á‡∏û‡∏£‡πà‡∏∏‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏î‡πÇ‡∏´‡∏î'
        ]
      },
      {
        id: 'blade',
        type: 'weapon',
        name: '‡∏î‡∏≤‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß',
        maxLevel: 4,
        descLv: [
          '‡∏ß‡∏á‡∏î‡∏≤‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡πÄ‡∏°‡∏à',
          '‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏ß‡∏á‡∏î‡∏≤‡∏ö‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß'
        ]
      },
      {
        id: 'boots',
        type: 'passive',
        name: '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ö‡∏π‡∏ó 7 ‡∏•‡∏µ‡πâ',
        maxLevel: 4,
        descLv: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ß‡∏¥‡πà‡∏á',
          '‡∏ä‡∏ô‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏≥‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢',
          '‡∏•‡∏î‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
          '‡πÄ‡∏£‡πá‡∏ß‡∏à‡∏±‡∏î ‡πÉ‡∏Å‡∏•‡πâ‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡∏°‡∏¥‡∏ï‡∏¥'
        ]
      },
      {
        id: 'pepper',
        type: 'weapon',
        name: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏ï‡∏¥‡πä‡∏Å‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢',
        maxLevel: 4,
        descLv: [
          '‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡πÇ‡∏•‡∏ß‡πå',
          '‡∏™‡πÇ‡∏•‡∏ß‡πå‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏™‡πÇ‡∏•‡∏ß‡πå‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏™‡πÇ‡∏•‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å ‡πÜ'
        ]
      },
      {
        id: 'fan',
        type: 'weapon',
        name: '‡∏û‡∏±‡∏î‡∏•‡∏°‡πÑ‡∏≠‡πÄ‡∏¢‡πá‡∏ô',
        maxLevel: 3,
        descLv: [
          '‡∏ß‡∏á‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏™‡πÇ‡∏•‡∏ß‡πå‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß',
          '‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏ó‡∏≥‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏≤ ‡πÜ'
        ]
      },
      {
        id: 'burst',
        type: 'weapon',
        name: '‡∏û‡∏∏‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß',
        maxLevel: 3,
        descLv: [
          '‡∏¢‡∏¥‡∏á‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô 8 ‡∏ó‡∏¥‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á ‡πÜ',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏∏‡πà‡∏á',
          '‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á'
        ]
      },
      // Stats
      {
        id: 'might',
        type: 'stat',
        name: 'Might (‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ)',
        maxLevel: 5,
        descLv: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡πÄ‡∏°‡∏à‡∏≠‡∏µ‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
          '‡∏î‡∏≤‡πÄ‡∏°‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏î‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏î‡∏≤‡πÄ‡∏°‡∏à‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å',
          '‡∏û‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏µ‡∏î'
        ]
      },
      {
        id: 'area',
        type: 'stat',
        name: 'Area (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏à‡∏°‡∏ï‡∏µ)',
        maxLevel: 5,
        descLv: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò',
          '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å',
          '‡∏ß‡∏á‡∏î‡∏≤‡∏ö/‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡πÅ‡∏ó‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏ï‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢',
          'Area ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏î'
        ]
      },
      {
        id: 'cooldown',
        type: 'stat',
        name: 'Cooldown (‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå)',
        maxLevel: 5,
        descLv: [
          '‡∏•‡∏î‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
          '‡∏¢‡∏¥‡∏á‡∏ñ‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏¢‡∏¥‡∏á‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏Å',
          '‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡πÅ‡∏ó‡∏ö‡∏¢‡∏¥‡∏á‡∏£‡∏±‡∏ß‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤',
          'Cooldown ‡πÅ‡∏ó‡∏ö‡∏´‡∏≤‡∏¢‡πÑ‡∏õ'
        ]
      },
      {
        id: 'luck',
        type: 'stat',
        name: 'Luck (‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ)',
        maxLevel: 5,
        descLv: [
          '‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏™‡∏Å‡∏¥‡∏•‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡∏î‡∏£‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡∏î‡∏µ‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡∏ß‡∏á‡∏î‡∏µ‡∏ñ‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô',
          '‡πÇ‡∏ä‡∏Ñ‡πÇ‡∏Ñ‡∏ï‡∏£‡∏î‡∏µ',
          '‡πÇ‡∏ä‡∏Ñ‡πÅ‡∏ï‡∏Å‡∏™‡∏∏‡∏î ‡πÜ'
        ]
      },
      {
        id: 'curse',
        type: 'stat',
        name: 'Curse (‡∏Ñ‡∏≥‡∏™‡∏≤‡∏õ)',
        maxLevel: 5,
        descLv: [
          '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÅ‡∏•‡∏Å EXP)',
          '‡∏°‡∏≠‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å',
          '‡∏ó‡πà‡∏ß‡∏°‡∏à‡∏≠ ‡πÅ‡∏ï‡πà‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏™‡∏∏‡∏î‡∏°‡∏±‡∏ô',
          '‡∏°‡∏≠‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏ô‡∏à‡∏≠‡πÅ‡∏ó‡∏ö‡πÅ‡∏ï‡∏Å',
          '‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á'
        ]
      }
    ];

    const POWER_UP_DEFS = [
      {
        id: 'hpUp',
        name: '‡πÄ‡∏û‡∏¥‡πà‡∏° HP ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
        desc: '‡πÄ‡∏û‡∏¥‡πà‡∏° HP ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô +10 ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡πÄ‡∏ß‡∏•',
        maxLevel: 5,
        baseCost: 50
      },
      {
        id: 'speedUp',
        name: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
        desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
        maxLevel: 5,
        baseCost: 50
      },
      {
        id: 'mightUp',
        name: '‡πÄ‡∏û‡∏¥‡πà‡∏° Might ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
        desc: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô',
        maxLevel: 3,
        baseCost: 80
      },
      {
        id: 'luckUp',
        name: '‡πÄ‡∏û‡∏¥‡πà‡∏° Luck ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
        desc: '‡∏î‡∏ß‡∏á‡∏î‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°',
        maxLevel: 3,
        baseCost: 80
      }
    ];
    // === SPRITES ========================================================
  const SPRITE_SOURCES = {
    player: {
      pong: 'assets/characters/pong.png',
      ning: 'assets/characters/ning.png',
      cat:  'assets/characters/cat.png'
    },
    stage: {
      garbage:   'assets/stages/garbage.png',
      market:    'assets/stages/market.png',
      classroom: 'assets/stages/classroom.png'
    },
    monster: {
      slime:    'assets/monsters/slime.png',
      roach:    'assets/monsters/roach.png',
      chicken:  'assets/monsters/chicken.png',
      duck:     'assets/monsters/duck.png',
      ghost:    'assets/monsters/ghost.png',
      mathBoss: 'assets/monsters/mathBoss.png'
    }
  };

  const SPRITES = {
    player: {},
    stage: {},
    monster: {}
  };

  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  function loadAllSprites() {
    for (const key in SPRITE_SOURCES.player) {
      const img = new Image();
      img.src = SPRITE_SOURCES.player[key];
      SPRITES.player[key] = img;
    }
    for (const key in SPRITE_SOURCES.stage) {
      const img = new Image();
      img.src = SPRITE_SOURCES.stage[key];
      SPRITES.stage[key] = img;
    }
    for (const key in SPRITE_SOURCES.monster) {
      const img = new Image();
      img.src = SPRITE_SOURCES.monster[key];
      SPRITES.monster[key] = img;
    }
  }

  // === SOUND EFFECTS ==========================================
  const SFX = {};

  let bgm = null;

  function initBgm() {
    if (bgm) return;
    // ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á‡πÄ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    bgm = new Audio('assets/bgm/main_theme.mp3');
    bgm.loop = true;
    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å slider ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô default = 0.6
    const defaultVol = volumeSlider ? (volumeSlider.value / 100) : 0.6;
    bgm.volume = defaultVol;
  }

    function playBgm() {
    initBgm();
    // ‡∏ö‡∏≤‡∏á browser ‡∏à‡∏∞ block ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ user interaction ‡πÅ‡∏ï‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î Start ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÇ‡∏≠‡πÄ‡∏Ñ
    bgm.play().catch(() => {});
  }

  function stopBgm() {
    if (bgm) {
      bgm.pause();
    }
  }

  function loadSounds() {
    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ
    const levelUp = new Audio('assets/sfx/levelup.mp3');
    levelUp.volume = 0.7; // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á 0.0 - 1.0
    SFX.levelup = levelUp;
  }

  function loadSounds() {
    // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ
    const levelUp = new Audio('assets/sfx/levelup.mp3');
    levelUp.volume = 0.7; // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á 0.0 - 1.0
    SFX.levelup = levelUp;
  }

  function playSfx(name) {
    const s = SFX[name];
    if (!s) return;
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏ô
    try {
      s.currentTime = 0;
      s.play().catch(() => {});
    } catch (e) {}
  }



    

    // === STATE =======================================================
    const state = {
      running: false,
      inLevelUp: false,

      characterId: null,
      stageId: null,

      player: {
        x: 0,
        y: 0,
        radius: 14,
        speed: 220,
        maxHp: 120,
        hp: 120,
        level: 1,
        xp: 0,
        xpToNext: 5
      },

      baseDamage: 1.2,
      weaponType: 'stick',

      enemies: [],
      bullets: [],
      items: [],
      skills: {}, // skillId -> level
      stats: { might: 1, area: 1, cooldown: 1, luck: 1, curse: 1 },

      spinBladeAngle: 0,

      time: 0,
      kills: 0,
      goldRun: 0,
      lastTimestamp: 0,
      spawnTimer: 0,
      spawnInterval: 1300,
      shootTimer: 0,
      burstTimer: 0,
      bossSpawned: false,

      destinyTimer: 0,
      destinyActive: null,
      destinyTimeLeft: 0,

      keys: {},
      joystick: { x: 0, y: 0, active: false },

      passiveEffects: {
        trashTreasure: false,
        crispyBuff: false,
        sleepBuff: false,
        sleepStun: 0,
        sleepBuffTime: 0
      },

      pepperEvolved: false, // ‡∏õ‡∏∑‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏Å‡πä‡∏™‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢
      effects: [],
      damageTexts: []
    };

    // === CANVAS RESIZE ===============================================
    function resizeCanvas() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // ‚òÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô (0,0) ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ß‡πâ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
      if (!state.running && state.player.x === 0 && state.player.y === 0) {
        state.player.x = rect.width / 2;
        state.player.y = rect.height / 2;
      }
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // === INPUT: KEYBOARD =============================================
    window.addEventListener('keydown', (e) => {
      state.keys[e.code] = true;
    });
    window.addEventListener('keyup', (e) => {
      state.keys[e.code] = false;
    });

    // === INPUT: JOYSTICK =============================================
    function updateJoystickFromEvent(e) {
      const rect = joystick.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      const cx = rect.width / 2;
      const cy = rect.height / 2;
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      let dx = x - cx;
      let dy = y - cy;
      const dist = Math.hypot(dx, dy) || 1;
      const maxDist = rect.width / 2 - 10;
      if (dist > maxDist) {
        dx = dx / dist * maxDist;
        dy = dy / dist * maxDist;
      }
      joystickKnob.style.transform = `translate(${dx}px, ${dy}px)`;
      if (dist > 10) {
        state.joystick.x = dx / dist;
        state.joystick.y = dy / dist;
      } else {
        state.joystick.x = 0;
        state.joystick.y = 0;
      }
    }
    function resetJoystick() {
      state.joystick.x = 0;
      state.joystick.y = 0;
      joystickKnob.style.transform = 'translate(0,0)';
      state.joystick.active = false;
    }

    joystick.addEventListener('touchstart', (e) => {
      e.preventDefault();
      state.joystick.active = true;
      updateJoystickFromEvent(e);
    }, { passive: false });
    joystick.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!state.joystick.active) return;
      updateJoystickFromEvent(e);
    }, { passive: false });
    joystick.addEventListener('touchend', (e) => { e.preventDefault(); resetJoystick(); }, { passive: false });
    joystick.addEventListener('touchcancel', (e) => { e.preventDefault(); resetJoystick(); }, { passive: false });

    joystick.addEventListener('mousedown', (e) => {
      e.preventDefault();
      state.joystick.active = true;
      updateJoystickFromEvent(e);
    });
    window.addEventListener('mousemove', (e) => {
      if (!state.joystick.active) return;
      updateJoystickFromEvent(e);
    });
    window.addEventListener('mouseup', resetJoystick);

    // === UI: BUILD CHARACTER / STAGE / POWERUPS ======================
    function buildCharacterCards() {
      characterListEl.innerHTML = '';
      for (const id in CHARACTERS) {
        const c = CHARACTERS[id];
        const btn = document.createElement('button');
        btn.className =
          `char-card text-left rounded-2xl border bg-slate-900/80 px-3 py-2 hover:bg-slate-800/80 transition ${c.color}`;
        btn.dataset.charId = id;
        btn.innerHTML = `
          <div class="text-[10px] text-slate-400 mb-1 uppercase">${id}</div>
          <div class="text-[13px] font-semibold mb-1">${c.name}</div>
          <div class="text-[11px] text-slate-300 leading-snug">${c.desc}</div>
        `;
        btn.addEventListener('click', () => {
          state.characterId = id;
          updateCharStageSelection();
        });
        characterListEl.appendChild(btn);
      }
    }

    function buildStageCards() {
      stageListEl.innerHTML = '';
      Object.values(STAGES).forEach(s => {
        const btn = document.createElement('button');
        btn.className =
          'stage-card text-left rounded-2xl border border-slate-600 bg-slate-900/80 px-3 py-2 hover:bg-slate-800/80 transition';
        btn.dataset.stageId = s.id;
        btn.innerHTML = `
          <div class="text-[10px] text-slate-400 mb-1 uppercase">${s.id}</div>
          <div class="text-[13px] font-semibold mb-1">${s.name}</div>
          <div class="text-[11px] text-slate-300 leading-snug">${s.desc}</div>
        `;
        btn.addEventListener('click', () => {
          state.stageId = s.id;
          updateCharStageSelection();
        });
        stageListEl.appendChild(btn);
      });
    }

    function updateCharStageSelection() {
      document.querySelectorAll('.char-card').forEach(btn => {
        if (btn.dataset.charId === state.characterId) {
          btn.classList.add('ring-2', 'ring-cyan-400');
        } else {
          btn.classList.remove('ring-2', 'ring-cyan-400');
        }
      });
      document.querySelectorAll('.stage-card').forEach(btn => {
        if (btn.dataset.stageId === state.stageId) {
          btn.classList.remove('border-slate-600');
          btn.classList.add('border-cyan-400', 'bg-slate-800/90');
        } else {
          btn.classList.add('border-slate-600');
          btn.classList.remove('border-cyan-400', 'bg-slate-800/90');
        }
      });

      btnStartRun.disabled = !(state.characterId && state.stageId);
    }

    function updateSkillBar() {
      const ids = Object.keys(state.skills);
      const maxSlots = 6;
      let html = '';
      for (let i = 0; i < maxSlots; i++) {
        if (i < ids.length) {
          const id = ids[i];
          const level = state.skills[id];
          const def = SKILLS.find(s => s.id === id);
          html += `
            <div class="rounded-xl bg-slate-800/90 border border-cyan-500/60 px-2 py-1 flex flex-col">
              <span class="text-[10px] font-semibold text-cyan-300 truncate">${def ? def.name : id}</span>
              <span class="text-[10px] text-slate-300">LV ${level}</span>
            </div>
          `;
        } else {
          html += `
            <div class="rounded-xl bg-slate-800/40 border border-slate-700/70 px-2 py-1 flex items-center justify-center text-slate-500">
              -
            </div>
          `;
        }
      }
      skillBarEl.innerHTML = html;
    }

    function buildPowerupCards() {
      powerupListEl.innerHTML = '';
      POWER_UP_DEFS.forEach(def => {
        const level = meta.powerups[def.id] || 0;
        const nextLevel = level + 1;
        const cost = Math.round(def.baseCost * (1 + level * 0.8));
        const maxed = level >= def.maxLevel;

        const card = document.createElement('button');
        card.className =
          'text-left rounded-2xl border border-slate-600 bg-slate-900/90 px-3 py-2 hover:bg-slate-800/90 transition disabled:opacity-40 disabled:cursor-not-allowed';
        card.disabled = maxed || meta.gold < cost;
        card.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <span class="text-[13px] font-semibold text-emerald-300">${def.name}</span>
            <span class="text-[10px] text-slate-400">LV ${level}/${def.maxLevel}</span>
          </div>
          <div class="text-[11px] text-slate-200 mb-1">${def.desc}</div>
          <div class="text-[11px] text-yellow-300">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: ${maxed ? '‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : cost + ' ‡∏ó‡∏≠‡∏á'}</div>
        `;
        card.addEventListener('click', () => {
          if (maxed) return;
          if (meta.gold < cost) return;
          meta.gold -= cost;
          meta.powerups[def.id] = nextLevel;
          saveMeta();
          buildPowerupCards();
        });
        powerupListEl.appendChild(card);
      });
      metaGoldLabel.textContent = meta.gold.toString();
      metaGoldLabel2.textContent = meta.gold.toString();
    }

    // === HP / XP / GOLD UI ===========================================
    function updateHpUi() {
      const p = state.player;
      hpBar.style.width = `${Math.max(0, Math.min(1, p.hp / p.maxHp)) * 100}%`;
    }

    function updateXpUi() {
      const p = state.player;
      xpBar.style.width = `${Math.max(0, Math.min(1, p.xp / p.xpToNext)) * 100}%`;
      levelLabel.textContent = p.level.toString();
    }

    function addGold(amount) {
      state.goldRun += amount;
      goldRunLabel.textContent = Math.round(state.goldRun).toString();
    }

    // === ENEMY SPAWN / BOSS ==========================================
    function spawnEnemy() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      const side = Math.floor(Math.random() * 4);
      let x, y;
      if (side === 0) { x = Math.random() * w; y = -20; }
      else if (side === 1) { x = w + 20; y = Math.random() * h; }
      else if (side === 2) { x = Math.random() * w; y = h + 20; }
      else { x = -20; y = Math.random() * h; }

      const t = Math.random();
      let type = 'slime';
      let radius = 12;
      let baseHp = 3 + state.time * 0.08;
      let speed = 60;
      let xp = 1;
      let goldValue = 1;

      const curseFactor = 1 + (state.stats.curse - 1) * 0.5;
      baseHp *= curseFactor;

      const stage = state.stageId;
      if (stage === 'garbage') {
        if (t < 0.4) { type = 'slime'; speed = 55; xp = 1; goldValue = 1; }
        else if (t < 0.7) { type = 'roach'; radius = 7; baseHp = 1.2; speed = 120; xp = 0.5; goldValue = 3; }
        else { type = 'chicken'; radius = 13; speed = 130; xp = 2; goldValue = 2; }
      } else if (stage === 'market') {
        if (t < 0.3) { type = 'duck'; radius = 16; speed = 80; xp = 2; goldValue = 2; }
        else if (t < 0.6) { type = 'chicken'; radius = 13; speed = 140; xp = 2; goldValue = 2; }
        else { type = 'slime'; speed = 70; xp = 1; goldValue = 1; }
      } else if (stage === 'classroom') {
        if (t < 0.4) { type = 'ghost'; radius = 16; speed = 40; xp = 2; goldValue = 2; }
        else if (t < 0.7) { type = 'roach'; radius = 7; speed = 110; xp = 0.5; goldValue = 3; }
        else { type = 'duck'; radius = 16; speed = 80; xp = 2; goldValue = 2; }
      }

      state.enemies.push({
        x, y,
        radius,
        speed,
        hp: baseHp,
        maxHp: baseHp,
        type,
        isBoss: false,
        slowTimer: 0,
        goldValue,
        hitFlash: 0   // ‚òÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      });

    }

    function spawnBoss() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      let type = 'boss';
      if (state.stageId === 'classroom') type = 'mathBoss';

      const hpBase = 200 + state.time * 2;
      const curseFactor = 1 + (state.stats.curse - 1) * 0.7;

      state.enemies.push({
        x: w / 2,
        y: -60,
        radius: 32,
        speed: 40,
        hp: hpBase * curseFactor,
        maxHp: hpBase * curseFactor,
        type,
        isBoss: true,
        projTimer: 0,
        goldValue: 30,
        hitFlash: 0   // ‚òÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
      });

      state.bossSpawned = true;
      updateBossUi();
    }

    function updateBossUi() {
      const boss = state.enemies.find(e => e.isBoss);
      if (!boss) {
        bossHpContainer.classList.add('hidden');
        return;
      }
      bossHpContainer.classList.remove('hidden');
      bossNameLabel.textContent =
        boss.type === 'mathBoss' ? '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : 'Boss';
      const ratio = boss.hp / boss.maxHp;
      bossHpBar.style.width = `${Math.max(0, Math.min(1, ratio)) * 100}%`;
    }

    // === SHOOT / SKILLS ==============================================
    function shootMainWeapon() {
      if (state.enemies.length === 0) return;
      const p = state.player;

      // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏°‡∏ß‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏ö -> ‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏¥‡∏á
      if (state.passiveEffects.sleepStun > 0) return;

      let target = null;
      let bestDist = Infinity;
      state.enemies.forEach(e => {
        const d = Math.hypot(e.x - p.x, e.y - p.y);
        if (d < bestDist) { bestDist = d; target = e; }
      });
      if (!target) return;

      const dx = target.x - p.x;
      const dy = target.y - p.y;
      let angle = Math.atan2(dy, dx);
      const baseSpeed = 310;

      const bulletsAngles = [];
      const multiLv = state.skills['multi'] || 0;
      const countExtra = multiLv;
      const spread = (10 + multiLv * 6) * Math.PI / 180;

      bulletsAngles.push(angle);
      for (let i = 1; i <= countExtra; i++) {
        bulletsAngles.push(angle + spread * i);
        bulletsAngles.push(angle - spread * i);
      }

      let dmgBase = state.baseDamage * state.stats.might;

      // ‡πÄ‡∏à‡πä‡∏´‡∏ô‡∏¥‡∏á: ‡∏ö‡∏±‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠ HP < 50%
      if (state.passiveEffects.crispyBuff && state.player.hp < state.player.maxHp * 0.5) {
        dmgBase *= 1.3;
      }

      bulletsAngles.forEach(a => {
        state.bullets.push({
          x: p.x,
          y: p.y,
          radius: 4,
          vx: Math.cos(a) * baseSpeed,
          vy: Math.sin(a) * baseSpeed,
          damage: dmgBase,
          type: state.weaponType
        });
      });
    }

    function applySkillLevel(id, level) {
      if (id === 'boots') {
        const baseSpeed = CHARACTERS[state.characterId].speed +
          (meta.powerups.speedUp || 0) * 8;
        state.player.speed = baseSpeed + level * 15;
      } else if (id === 'might') {
        state.stats.might = 1 + level * 0.15 + (meta.powerups.mightUp || 0) * 0.1;
      } else if (id === 'area') {
        state.stats.area = 1 + level * 0.12;
      } else if (id === 'cooldown') {
        state.stats.cooldown = 1 + level * 0.18;
      } else if (id === 'luck') {
        state.stats.luck = 1 + level * 0.2 + (meta.powerups.luckUp || 0) * 0.1;
      } else if (id === 'curse') {
        state.stats.curse = 1 + level * 0.25;
      } else if (id === 'pepper') {
        if (level >= 4 && !state.pepperEvolved && state.time > 10 * 60) {
          // ‡∏¢‡∏∏‡∏Ñ‡∏õ‡∏∑‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏Å‡πä‡∏™‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢
          state.pepperEvolved = true;
          showDestinyBanner('‡∏ß‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£: ‡∏õ‡∏∑‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏Å‡πä‡∏™‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢!');
        }
      }
    }

    function openLevelUp() {
      state.inLevelUp = true;
      screenLevelup.classList.remove('hidden');

      const available = SKILLS.filter(s => (state.skills[s.id] || 0) < s.maxLevel);
      if (available.length === 0) {
        state.inLevelUp = false;
        screenLevelup.classList.add('hidden');
        return;
      }
      const shuffled = [...available].sort(() => Math.random() - 0.5);
      const luckFactor = state.stats.luck;
      const count = luckFactor > 1.6 ? 4 : 3;
      const options = shuffled.slice(0, Math.min(count, shuffled.length));

      levelupOptionsEl.innerHTML = '';
      options.forEach(def => {
        const lv = state.skills[def.id] || 0;
        const nextLv = lv + 1;
        const desc = def.descLv[Math.min(def.descLv.length - 1, lv)];
        const btn = document.createElement('button');
        btn.className =
          'skill-opt text-left rounded-2xl border border-slate-600 bg-slate-900/80 hover:bg-slate-800/80 hover:border-cyan-400 px-3 py-2 transition';
        btn.dataset.skillId = def.id;
        btn.innerHTML = `
          <div class="text-[10px] text-slate-400 mb-1">LV ${nextLv}/${def.maxLevel}</div>
          <div class="text-[13px] font-semibold ${def.type === 'stat' ? 'text-emerald-300' : 'text-cyan-300'} mb-1">
            ${def.name}
          </div>
          <div class="text-[11px] text-slate-200">${desc}</div>
        `;
        btn.addEventListener('click', () => {
          state.skills[def.id] = nextLv;
          applySkillLevel(def.id, nextLv);
          updateSkillBar();
          state.inLevelUp = false;
          screenLevelup.classList.add('hidden');
        });
        levelupOptionsEl.appendChild(btn);
      });
    }

    // === DESTINY EVENTS (‡∏ù‡∏ô‡∏õ‡∏•‡∏≤‡∏ó‡∏π / ‡∏û‡∏≤‡∏¢‡∏∏‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞) ================
    function triggerRandomDestiny() {
      const r = Math.random();
      if (r < 0.5) {
        state.destinyActive = 'fishRain';
        state.destinyTimeLeft = 8;
        showDestinyBanner('‡∏ù‡∏ô‡∏õ‡∏•‡∏≤‡∏ó‡∏π! ‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÑ‡∏ñ‡∏•‡πÑ‡∏õ‡∏°‡∏≤');
      } else {
        state.destinyActive = 'sandalStorm';
        state.destinyTimeLeft = 6;
        showDestinyBanner('‡∏û‡∏≤‡∏¢‡∏∏‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞! ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ü‡∏≤‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π');
      }
    }

    function showDestinyBanner(text) {
      destinyBanner.textContent = '‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡∏ü‡πâ‡∏≤‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï: ' + text;
      destinyBanner.classList.remove('hidden');
      setTimeout(() => {
        destinyBanner.classList.add('hidden');
      }, 3000);
    }

    function destinyEffects(dt) {
      if (!state.destinyActive) return;
      state.destinyTimeLeft -= dt;
      if (state.destinyTimeLeft <= 0) {
        state.destinyActive = null;
        return;
      }

      if (state.destinyActive === 'fishRain') {
        // ‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ
        state.enemies.forEach((e, i) => {
          if (i % 3 === 0) {
            e.x += Math.sin(state.time * 3 + i) * 30 * dt;
          }
        });
      } else if (state.destinyActive === 'sandalStorm') {
        // ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏ï‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏Å‡πÉ‡∏™‡πà‡∏®‡∏±‡∏ï‡∏£‡∏π
        if (Math.random() < 0.6 * dt) {
          const root = document.getElementById('game-root');
          const rect = root.getBoundingClientRect();
          const x = Math.random() * rect.width;
          const target = state.enemies[Math.floor(Math.random() * state.enemies.length)];
          if (target) {
            target.hp -= 10 * state.stats.might;
          }
        }
      }
    }



    // === DROPS & EFFECTS ==========================================
    function createDeathEffect(enemy) {
      const isBoss = enemy.isBoss;

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π
      const baseR = enemy.radius;
      const maxR = isBoss ? baseR * 3.2 : baseR * 2.0;

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏≠‡∏≠‡∏Å (‡∏ö‡∏≠‡∏™ = ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏á)
      const rings = isBoss ? 3 : 1;

      for (let i = 0; i < rings; i++) {
        state.effects.push({
          x: enemy.x,
          y: enemy.y,
          // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          r: baseR + i * 4,
          // ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
          maxR: maxR + i * 12,
          life: 0,
          maxLife: isBoss ? 0.55 : 0.35,
          // ‡∏™‡∏µ prefix ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà drawEffects ‡πÉ‡∏ä‡πâ
          // ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏õ‡∏Å‡∏ï‡∏¥ = ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô, ‡∏ö‡∏≠‡∏™ = ‡πÅ‡∏î‡∏á‡∏ä‡∏°‡∏û‡∏π
          colorPrefix: isBoss
            ? 'rgba(248,113,113,'  // #fb7185
            : 'rgba(96,165,250,'   // #60a5fa
        });
      }
    }


    function dropFromEnemy(enemy) {
      const luck = state.stats.luck;
      let baseXp = enemy.isBoss ? 15 : (enemy.type === 'roach' ? 0.6 : 1.2);
      let baseGold = enemy.isBoss ? (enemy.goldValue || 30) : (enemy.goldValue || 1);

      if (enemy.type === 'roach') baseGold *= 2;
      if (Math.random() < 0.2 * (luck - 1)) baseGold *= 1.5;

      const drops = [];

      if (enemy.isBoss) {
        drops.push({ type: 'expBig', xp: baseXp * 2, gold: 0 });
        drops.push({ type: 'expBig', xp: baseXp * 1.5, gold: 0 });
        drops.push({ type: 'chest', xp: baseXp * 2, gold: baseGold + 10 });
      } else {
        drops.push({ type: 'expSmall', xp: baseXp, gold: 0 });
        if (Math.random() < 0.35) {
          drops.push({ type: 'coin', xp: 0, gold: baseGold });
        }
      }

      drops.forEach(d => {
        const angle = Math.random() * Math.PI * 2;
        const dist = 6 + Math.random() * 16;

        state.items.push({
          x: enemy.x + Math.cos(angle) * dist,
          y: enemy.y + Math.sin(angle) * dist,
          radius: (d.type === 'expBig' || d.type === 'chest') ? 9 : 6,
          type: d.type,
          xp: d.xp || 0,
          gold: d.gold || 0,
          vx: 0,      // ‚òÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          vy: 0,
          life: 0
        });
      });
    }
    
function updateItems(dt) {
  const root = document.getElementById('game-root');
  const rect = root.getBoundingClientRect();
  const w = rect.width;
  const h = rect.height;

  for (let i = state.items.length - 1; i >= 0; i--) {
    const it = state.items[i];
    it.life += dt;

    // ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡πÄ‡∏ö‡∏≤ ‡πÜ
    // it.x += it.vx * dt;
    // it.y += it.vy * dt;
    // it.vy += 60 * dt; // ‡πÅ‡∏£‡∏á‡πÇ‡∏ô‡πâ‡∏°‡∏ñ‡πà‡∏ß‡∏á

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≠‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
    if (it.x < -40 || it.x > w + 40 || it.y > h + 60) {
      state.items.splice(i, 1);
      continue;
    }

    // ‡πÅ‡∏£‡∏á‡∏î‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏•‡πá‡∏Å ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ
    const dx = state.player.x - it.x;
    const dy = state.player.y - it.y;
    const dist = Math.hypot(dx, dy) || 1;
    if (dist < 90) {
      const pull = 150 * dt;
      it.x += (dx / dist) * pull;
      it.y += (dy / dist) * pull;
    }

    // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ
    if (dist < state.player.radius + it.radius + 4) {
      if (it.xp) {
        state.player.xp += it.xp;
      }
      if (it.gold) {
        addGold(it.gold);
      }

      // Passive ‡∏•‡∏∏‡∏á‡∏õ‡πã‡∏≠‡∏á ‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞
      if (state.passiveEffects.trashTreasure &&
          Math.random() < 0.15 * state.stats.luck) {
        state.player.xp += 1.5;
      }

      updateXpUi();
      state.items.splice(i, 1);
    }
  }
}

function drawItems() {
  state.items.forEach(it => {
    ctx.save();
    let fill = '#38bdf8';
    if (it.type === 'expSmall') fill = '#22c55e';
    else if (it.type === 'expBig') fill = '#4ade80';
    else if (it.type === 'coin') fill = '#facc15';
    else if (it.type === 'chest') fill = '#f97316';

    ctx.translate(it.x, it.y);
    ctx.rotate(it.life * 3);
    ctx.beginPath();
    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏ä‡∏£ (‡∏´‡∏°‡∏∏‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°)
    ctx.moveTo(0, -it.radius);
    ctx.lineTo(it.radius, 0);
    ctx.lineTo(0, it.radius);
    ctx.lineTo(-it.radius, 0);
    ctx.closePath();
    ctx.fillStyle = fill;
    ctx.fill();

    ctx.restore();
  });
}

function updateDamageTexts(dt) {
  for (let i = state.damageTexts.length - 1; i >= 0; i--) {
    const t = state.damageTexts[i];
    t.life += dt;
    t.y -= 40 * dt; // ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ
    if (t.life >= t.maxLife) {
      state.damageTexts.splice(i, 1);
    }
  }
}

function drawDamageTexts() {
  state.damageTexts.forEach(t => {
    const alpha = 1 - t.life / t.maxLife;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = '#fecaca'; // ‡∏ä‡∏°‡∏û‡∏π‡πÅ‡∏î‡∏á ‡πÜ
    ctx.font = 'bold 12px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(t.value, t.x, t.y);
    ctx.restore();
  });
}



function drawEffects() {
  state.effects.forEach(ef => {
    const t = ef.life / ef.maxLife;
    const alpha = 1 - t;
    const radius = ef.r + (ef.maxR - ef.r) * t;

    ctx.save();
    ctx.beginPath();
    ctx.arc(ef.x, ef.y, radius, 0, Math.PI * 2);
    ctx.strokeStyle = ef.colorPrefix + alpha + ')';
    ctx.lineWidth =  ef.maxR > 50 ? 4 : 2;
    ctx.stroke();
    ctx.restore();
  });
}


function updateEffects(dt) {
  for (let i = state.effects.length - 1; i >= 0; i--) {
    const ef = state.effects[i];
    ef.life += dt;
    if (ef.life >= ef.maxLife) {
      state.effects.splice(i, 1);
    }
  }
}


    // === GAME LOOP UPDATE ============================================
    function update(dt) {
      if (!state.running) return;
      if (state.inLevelUp) return;

      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      state.time += dt;
      timeLabel.textContent = state.time.toFixed(1);

      state.destinyTimer += dt;
      if (state.destinyTimer > 30) {
        state.destinyTimer = 0;
        const luckBonus = state.stats.luck - 1;
        if (Math.random() < 0.4 + luckBonus * 0.1) {
          triggerRandomDestiny();
        }
      }

      

      // movement
      let mvx = 0, mvy = 0;
      if (state.joystick.x !== 0 || state.joystick.y !== 0) {
        mvx = state.joystick.x;
        mvy = state.joystick.y;
      } else {
        if (state.keys['KeyW'] || state.keys['ArrowUp']) mvy -= 1;
        if (state.keys['KeyS'] || state.keys['ArrowDown']) mvy += 1;
        if (state.keys['KeyA'] || state.keys['ArrowLeft']) mvx -= 1;
        if (state.keys['KeyD'] || state.keys['ArrowRight']) mvx += 1;
      }

      if (state.passiveEffects.sleepStun > 0) {
        mvx = 0; mvy = 0;
        state.passiveEffects.sleepStun -= dt;
      }

      if (mvx !== 0 || mvy !== 0) {
        const len = Math.hypot(mvx, mvy) || 1;
        mvx /= len;
        mvy /= len;
        state.player.x += mvx * state.player.speed * dt;
        state.player.y += mvy * state.player.speed * dt;
      }

      const r = state.player.radius;
      state.player.x = Math.max(r, Math.min(w - r, state.player.x));
      state.player.y = Math.max(r, Math.min(h - r, state.player.y));

      // shooting (cooldown based on stats.cooldown)
      state.shootTimer += dt * 1000;
      const shootInterval = 600 / state.stats.cooldown;
      if (state.shootTimer > shootInterval) {
        state.shootTimer = 0;
        shootMainWeapon();
      }

      // burst skill
      const burstLv = state.skills['burst'] || 0;
      if (burstLv > 0) {
        state.burstTimer += dt * 1000;
        const interval = 2600 - (burstLv - 1) * 400;
        if (state.burstTimer > interval) {
          state.burstTimer = 0;
          const count = 8 + (burstLv - 1) * 4;
          for (let i = 0; i < count; i++) {
            const a = (Math.PI * 2 * i) / count;
            state.bullets.push({
              x: state.player.x,
              y: state.player.y,
              radius: 3,
              vx: Math.cos(a) * 260,
              vy: Math.sin(a) * 260,
              damage: state.baseDamage * 0.8 * state.stats.might,
              type: 'burst'
            });
          }
        }
      }

      // spin blade
      if ((state.skills['blade'] || 0) > 0) {
        state.spinBladeAngle += dt * 4;
      }

      // spawn enemies (affected by Curse)
      state.spawnTimer += dt * 1000;
      const curseSpawnFactor = state.stats.curse;
      if (state.spawnTimer > state.spawnInterval / curseSpawnFactor) {
        state.spawnTimer = 0;
        spawnEnemy();
        state.spawnInterval = Math.max(450, state.spawnInterval * 0.99);
      }

      // spawn boss around 60s
      if (!state.bossSpawned && state.time > 60) {
        spawnBoss();
      }

      // bullets move
      for (let i = state.bullets.length - 1; i >= 0; i--) {
        const b = state.bullets[i];
        b.x += b.vx * dt;
        b.y += b.vy * dt;
        if (b.x < -40 || b.x > w + 40 || b.y < -40 || b.y > h + 40) {
          state.bullets.splice(i, 1);
        }
      }

      // destiny effects
      destinyEffects(dt);

      // enemies move & collisions
      for (let i = state.enemies.length - 1; i >= 0; i--) {
        const e = state.enemies[i];

        if (e.hitFlash > 0) {
          e.hitFlash -= dt;
          if (e.hitFlash < 0) e.hitFlash = 0;
        }

        const dx = state.player.x - e.x;
        const dy = state.player.y - e.y;
        const dist = Math.hypot(dx, dy) || 1;
        let vx = (dx / dist) * e.speed;
        let vy = (dy / dist) * e.speed;

        if (e.type === 'ghost') {
          vx *= 0.7; vy *= 0.7;
        }
        if (e.type === 'duck') {
          const angleOffset = Math.sin(state.time * 2 + i) * 0.4;
          const baseAngle = Math.atan2(dy, dx) + angleOffset;
          vx = Math.cos(baseAngle) * e.speed;
          vy = Math.sin(baseAngle) * e.speed;
        }
        if (state.destinyActive === 'fishRain') {
          vy += 20;
        }

        e.x += vx * dt;
        e.y += vy * dt;

        if (e.isBoss && e.type === 'mathBoss') {
          e.projTimer += dt * 1000;
          if (e.projTimer > 1500) {
            e.projTimer = 0;
            const angle = Math.atan2(dy, dx);
            state.bullets.push({
              x: e.x,
              y: e.y,
              radius: 5,
              vx: Math.cos(angle) * 190,
              vy: Math.sin(angle) * 190,
              damage: 20,
              type: 'mathBoss'
            });
          }
        }

        // bullets hit enemy
        for (let j = state.bullets.length - 1; j >= 0; j--) {
          const b = state.bullets[j];
          if (b.type === 'mathBoss') continue;
          const d = Math.hypot(b.x - e.x, b.y - e.y);
          if (d < e.radius + b.radius) {
            let damage = b.damage;

            const pepperLv = state.skills['pepper'] || 0;
            if (pepperLv > 0 && Math.random() < 0.3 + 0.1 * pepperLv) {
              e.speed *= 0.85;
            }

            if (b.type === 'chicken') {
              damage *= 0.9;
              const pieces = 3;
              for (let k = 0; k < pieces; k++) {
                const a = Math.random() * Math.PI * 2;
                state.bullets.push({
                  x: e.x,
                  y: e.y,
                  radius: 3,
                  vx: Math.cos(a) * 200,
                  vy: Math.sin(a) * 200,
                  damage: damage * 0.4,
                  type: 'shard'
                });
              }
            }

            if (b.type === 'fluff') {
              const aoeR = 25 * state.stats.area;
              state.enemies.forEach(e2 => {
                const d2 = Math.hypot(e2.x - e.x, e2.y - e.y);
                if (d2 < aoeR && e2 !== e) e2.hp -= damage * 0.5;
              });
            }

            // evolve pepper -> gas AoE
            if (state.pepperEvolved && state.weaponType === 'chicken') {
              // (‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ‡πÜ) ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
            }

            e.hp -= damage;

            e.hitFlash = 0.09;

            state.damageTexts.push({
              x: e.x,
              y: e.y - e.radius - 4,
              value: Math.round(damage),
              life: 0,
              maxLife: 0.5
            });

            state.bullets.splice(j, 1);
            if (e.hp <= 0) {
              // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å xp/gold ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‚Üí ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏£‡∏≠‡∏õ + ‡πÄ‡∏≠‡∏ü
              createDeathEffect(e);
              dropFromEnemy(e);

              state.kills += 1;
              killsLabel.textContent = state.kills.toString();

              state.enemies.splice(i, 1);
              if (e.isBoss) updateBossUi();
              break;
            }
          }
        }

        // enemy collide player
        const dp = Math.hypot(e.x - state.player.x, e.y - state.player.y);
        if (dp < e.radius + state.player.radius) {
          let dmg = 10;
          if (e.type === 'chicken') dmg = 15;
          if (e.isBoss) dmg = 25;
          if (e.type === 'roach') dmg = 5;

          const bootsLv = state.skills['boots'] || 0;
          if (bootsLv > 0) dmg *= (1 - 0.1 * bootsLv);

          state.player.hp -= dmg;
          updateHpUi();
          if (!e.isBoss) {
            state.enemies.splice(i, 1);
          }

          // ‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏î‡πâ: ‡∏Ç‡πÇ‡∏°‡∏¢‡∏ö‡∏±‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß -> ‡∏•‡∏î speed ‡πÄ‡∏£‡∏≤‡πÄ‡∏ö‡∏≤ ‡πÜ
          if (e.type === 'chicken') {
            state.player.speed *= 0.9;
          }

          if (state.player.hp <= 0) {
            state.player.hp = 0;
            updateHpUi();
            state.running = false;
            showGameOver();
            return;
          }
        }
      }

      // mathBoss projectile hit player
      for (let i = state.bullets.length - 1; i >= 0; i--) {
        const b = state.bullets[i];
        if (b.type !== 'mathBoss') continue;
        const d = Math.hypot(b.x - state.player.x, b.y - state.player.y);
        if (d < state.player.radius + b.radius) {
          state.player.hp -= b.damage;
          state.bullets.splice(i, 1);
          updateHpUi();
          if (state.player.hp <= 0) {
            state.running = false;
            showGameOver();
            return;
          }
        }
      }

      // fan (‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô) / blade damage over time
      const bladeLv = state.skills['blade'] || 0;
      if (bladeLv > 0) {
        const radius = (45 + bladeLv * 8) * state.stats.area;
        const px = state.player.x + Math.cos(state.spinBladeAngle) * radius;
        const py = state.player.y + Math.sin(state.spinBladeAngle) * radius;
        const bladeR = 12 + bladeLv * 2;
        state.enemies.forEach(e => {
          const d = Math.hypot(e.x - px, e.y - py);
          if (d < bladeR + e.radius) {
            e.hp -= (8 + bladeLv * 4) * state.stats.might * dt;
          }
        });
      }

      const fanLv = state.skills['fan'] || 0;
      if (fanLv > 0) {
        const fanR = 60 * state.stats.area + fanLv * 10;
        state.enemies.forEach(e => {
          const d = Math.hypot(e.x - state.player.x, e.y - state.player.y);
          if (d < fanR + e.radius) {
            e.speed *= (1 - 0.3 * dt);
            e.hp -= fanLv * 0.5 * dt;
          }
        });
      }

      // passive: ‡πÅ‡∏°‡∏ß‡∏™‡πâ‡∏° ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏ß‡∏á (‡∏™‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ‡πÉ‡∏ô openLevelUp)
      if (state.passiveEffects.sleepBuffTime > 0) {
        state.passiveEffects.sleepBuffTime -= dt;
        if (state.passiveEffects.sleepBuffTime <= 0) {
          // ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ü
          state.baseDamage /= 1.4;
        }
      }

      // Level up
      while (state.player.xp >= state.player.xpToNext) {
        state.player.xp -= state.player.xpToNext;
        state.player.level += 1;
        state.player.xpToNext = Math.round(state.player.xpToNext * 1.4 + 3);
        updateXpUi();
        state.player.maxHp += 3;
        state.player.hp += 3;
        updateHpUi();

        if (CHARACTERS[state.characterId].passive === 'sleepBuff') {
          if (Math.random() < 0.25) {
            state.passiveEffects.sleepStun = 2;
            setTimeout(() => {
              state.baseDamage *= 1.4;
              state.passiveEffects.sleepBuffTime = 10;
            }, 2000);
          }
        }

        // üîä ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏•
        playSfx('levelup');

        openLevelUp();
        break;
      }


      drawMiniMap();
      updateItems(dt);
      updateEffects(dt);
      updateDamageTexts(dt);

    }

    // === DRAW ========================================================
    function drawBackground() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      ctx.clearRect(0, 0, w, h);

      const img = SPRITES.stage[state.stageId];

      if (img && img.complete) {
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡∏¢‡∏∑‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏≠ (‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
        ctx.drawImage(img, 0, 0, w, h);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ / ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ background ‡πÄ‡∏î‡∏¥‡∏°
        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, w, h);
      }
    }


    function drawPlayer() {
      const p = state.player;
      const img = SPRITES.player[state.characterId];

      const size = 64; // ‚Üê ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô

      // ‡∏≠‡∏≠‡∏£‡πà‡∏≤‡∏Å‡∏•‡∏°‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß
      ctx.save();
      ctx.beginPath();
      ctx.arc(p.x, p.y, size / 2.1, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(56,189,248,0.18)';
      ctx.fill();
      ctx.restore();

      if (img && img.complete) {
        ctx.save();
        ctx.drawImage(img, p.x - size / 2, p.y - size / 2, size, size);
        // ‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ö‡∏≤‡∏á ‡πÜ
        ctx.strokeStyle = 'rgba(248,250,252,0.85)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(p.x, p.y, size / 2.1, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();
      } else {
        // fallback ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î
        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, size / 2.5, 0, Math.PI * 2);
        ctx.fillStyle = '#22d3ee';
        ctx.fill();
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }
    }



    function drawAuxSkills() {
      const bladeLv = state.skills['blade'] || 0;
      if (bladeLv > 0) {
        const radius = (45 + bladeLv * 8) * state.stats.area;
        const px = state.player.x + Math.cos(state.spinBladeAngle) * radius;
        const py = state.player.y + Math.sin(state.spinBladeAngle) * radius;

        ctx.save();
        ctx.beginPath();
        ctx.arc(px, py, 12 + bladeLv * 2, 0, Math.PI * 2);
        ctx.fillStyle = '#fb7185';
        ctx.fill();
        ctx.restore();
      }

      const fanLv = state.skills['fan'] || 0;
      if (fanLv > 0) {
        const fanR = 60 * state.stats.area + fanLv * 10;
        ctx.save();
        ctx.beginPath();
        ctx.arc(state.player.x, state.player.y, fanR, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(129,140,248,0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }
    }

    function drawBullets() {
      state.bullets.forEach(b => {
        ctx.save();
        if (b.type === 'stick') ctx.fillStyle = '#e5e7eb';
        else if (b.type === 'chicken') ctx.fillStyle = '#fed7aa';
        else if (b.type === 'fluff') ctx.fillStyle = '#f9a8d4';
        else if (b.type === 'burst') ctx.fillStyle = '#a5b4fc';
        else if (b.type === 'mathBoss') ctx.fillStyle = '#f97316';
        else ctx.fillStyle = '#e5e7eb';
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();

        if (b.type === 'mathBoss') {
          ctx.save();
          ctx.fillStyle = '#f9a8d4';
          ctx.font = '9px monospace';
          ctx.fillText('x¬≤+3?', b.x - 10, b.y - 8);
          ctx.restore();
        }
      });
    }

    function drawEnemies() {
      state.enemies.forEach(e => {
        let spriteKey = e.type;
        if (e.isBoss && e.type === 'mathBoss') {
          spriteKey = 'mathBoss';
        }

        const img = SPRITES.monster[spriteKey];

        if (img && img.complete) {
          const size = e.isBoss ? 72 : 40;
          ctx.save();
          ctx.drawImage(img, e.x - size / 2, e.y - size / 2, size, size);
          ctx.restore();
        } else {
          let color = '#f87171';
          if (e.type === 'slime') color = '#fb7185';
          else if (e.type === 'roach') color = '#a3a3a3';
          else if (e.type === 'chicken') color = '#fbbf24';
          else if (e.type === 'duck') color = '#60a5fa';
          else if (e.type === 'ghost') color = '#e5e7eb';
          else if (e.isBoss && e.type === 'mathBoss') color = '#38bdf8';
          else if (e.isBoss) color = '#f97316';

          ctx.save();
          ctx.beginPath();
          ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.fill();
          ctx.strokeStyle = 'rgba(15,23,42,0.8)';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.restore();
        }

        // ‚òÖ flash ‡∏Ç‡∏≤‡∏ß‡∏ó‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏°‡∏≠‡∏ô
        if (e.hitFlash > 0) {
          const alpha = e.hitFlash / 0.09; // ‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏¢‡∏¥‡πà‡∏á‡∏à‡∏≤‡∏á
          ctx.save();
          ctx.globalAlpha = alpha;
          ctx.beginPath();
          ctx.arc(e.x, e.y, e.radius + (e.isBoss ? 10 : 6), 0, Math.PI * 2);
          ctx.fillStyle = '#ffffff';
          ctx.fill();
          ctx.restore();
        }
      });
    }


    function drawMiniMap() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      const mmRect = minimapEl.getBoundingClientRect();
      const mmW = mmRect.width;
      const mmH = mmRect.height;

      minimapEl.innerHTML = '';
      const mmCanvas = document.createElement('canvas');
      mmCanvas.width = mmW;
      mmCanvas.height = mmH;
      const mmCtx = mmCanvas.getContext('2d');

      mmCtx.fillStyle = 'rgba(15,23,42,1)';
      mmCtx.fillRect(0, 0, mmW, mmH);

      mmCtx.fillStyle = '#22c55e';
      const px = (state.player.x / w) * mmW;
      const py = (state.player.y / h) * mmH;
      mmCtx.beginPath();
      mmCtx.arc(px, py, 3, 0, Math.PI * 2);
      mmCtx.fill();

      const boss = state.enemies.find(e => e.isBoss);
      if (boss) {
        mmCtx.fillStyle = '#f97316';
        const bx = (boss.x / w) * mmW;
        const by = (boss.y / h) * mmH;
        mmCtx.beginPath();
        mmCtx.arc(bx, by, 3, 0, Math.PI * 2);
        mmCtx.fill();
      }

      minimapEl.appendChild(mmCanvas);
    }

    function draw() {
      drawBackground();
      drawEffects();   // ‡πÄ‡∏≠‡∏ü‡∏ï‡∏±‡∏ß‡πÅ‡∏ï‡∏Å / spark
      drawItems();
      drawPlayer();
      drawAuxSkills();
      drawBullets();
      drawEnemies();
      drawDamageTexts();
    }


    // === GAME OVER ===================================================
    function showGameOver() {
      goTime.textContent = state.time.toFixed(1);
      goKills.textContent = state.kills.toString();
      goLevel.textContent = state.player.level.toString();
      goGold.textContent = Math.round(state.goldRun).toString();

      meta.gold += Math.round(state.goldRun);
      saveMeta();

      stopBgm();

      screenGameover.classList.remove('hidden');
      bossHpContainer.classList.add('hidden');
    }

    // === START RUN ===================================================
    function startRun() {
      const root = document.getElementById('game-root');
      const rect = root.getBoundingClientRect();

      const c = CHARACTERS[state.characterId];
      if (!c) return;

      state.player.x = rect.width / 2;
      state.player.y = rect.height / 2;

      const hpUpLv = meta.powerups.hpUp || 0;
      const speedUpLv = meta.powerups.speedUp || 0;
      const mightUpLv = meta.powerups.mightUp || 0;
      const luckUpLv = meta.powerups.luckUp || 0;

      state.player.maxHp = c.hp + hpUpLv * 10;
      state.player.hp = state.player.maxHp;
      state.player.level = 1;
      state.player.xp = 0;
      state.player.xpToNext = 5;

      state.baseDamage = c.baseDamage * (1 + mightUpLv * 0.1);
      state.player.speed = c.speed + speedUpLv * 8;
      state.weaponType = c.weaponType;

      state.enemies = [];
      state.bullets = [];
      state.items = [];
      state.skills = {};
      state.stats = {
        might: 1 + mightUpLv * 0.1,
        area: 1,
        cooldown: 1,
        luck: 1 + luckUpLv * 0.1,
        curse: 1
      };
      state.spinBladeAngle = 0;

      state.time = 0;
      state.kills = 0;
      state.goldRun = 0;
      state.spawnTimer = 0;
      state.spawnInterval = 1300;
      state.shootTimer = 0;
      state.burstTimer = 0;
      state.bossSpawned = false;
      state.destinyTimer = 0;
      state.destinyActive = null;
      state.destinyTimeLeft = 0;
      state.pepperEvolved = false;

      state.passiveEffects.trashTreasure = c.passive === 'trashTreasure';
      state.passiveEffects.crispyBuff = c.passive === 'crispyBuff';
      state.passiveEffects.sleepBuff = c.passive === 'sleepBuff';
      state.passiveEffects.sleepStun = 0;
      state.passiveEffects.sleepBuffTime = 0;

      state.running = true;
      state.inLevelUp = false;

      screenMainMenu.classList.add('hidden');
      screenCharStage.classList.add('hidden');
      screenLevelup.classList.add('hidden');
      screenGameover.classList.add('hidden');
      screenPowerups.classList.add('hidden');

      playBgm();

      updateHpUi();
      updateXpUi();
      killsLabel.textContent = '0';
      goldRunLabel.textContent = '0';
      updateSkillBar();
      updateBossUi();
    }

    // === MAIN MENU BUTTONS ===========================================
    btnMainStart.addEventListener('click', () => {
      screenMainMenu.classList.add('hidden');
      screenCharStage.classList.remove('hidden');
    });

    btnMainPowerups.addEventListener('click', () => {
      screenPowerups.classList.remove('hidden');
      buildPowerupCards();
    });

    btnClosePowerups.addEventListener('click', () => {
      screenPowerups.classList.add('hidden');
    });

    btnStartRun.addEventListener('click', () => {
      if (!state.characterId || !state.stageId) return;
      startRun();
    });

    btnRestart.addEventListener('click', () => {
      state.running = false;
      screenGameover.classList.add('hidden');
      screenMainMenu.classList.remove('hidden');
      screenCharStage.classList.add('hidden');
    });

    // === LOOP ========================================================
    function loop(timestamp) {
      if (!state.lastTimestamp) state.lastTimestamp = timestamp;
      const dt = (timestamp - state.lastTimestamp) / 1000;
      state.lastTimestamp = timestamp;

      update(dt);
      draw();

      requestAnimationFrame(loop);
    }

    // init
    metaGoldLabel.textContent = meta.gold.toString();
    metaGoldLabel2.textContent = meta.gold.toString();
    buildCharacterCards();
    buildStageCards();
    updateCharStageSelection();
    updateSkillBar();
    updateBossUi();

    loadAllSprites(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
    loadSounds();     // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á  <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

    requestAnimationFrame(loop);


  </script>
</body>
</html>
